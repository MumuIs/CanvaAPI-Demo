<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Canva Connect 电商 Demo - 同事快速启动（macOS）</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --primary: #00B79B;
        --text: #1f2937; /* gray-800 */
        --muted: #6b7280; /* gray-500 */
        --border: #e5e7eb; /* gray-200 */
      }
      * { box-sizing: border-box; }
      html, body { margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--text); }
      .page { max-width: 900px; margin: 32px auto; padding: 32px; border: 1px solid var(--border); border-radius: 12px; }
      h1 { font-size: 22px; margin: 0 0 16px; }
      h2 { font-size: 18px; margin: 24px 0 8px; }
      p { margin: 8px 0; line-height: 1.6; }
      code, .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #f8fafc; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); }
      .block { background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; }
      .steps { display: grid; gap: 12px; }
      .step { border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
      .title { display: flex; align-items: center; gap: 8px; font-weight: 700; }
      .badge { color: #fff; background: var(--primary); padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; letter-spacing: .3px; }
      .muted { color: var(--muted); }
      .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .small { font-size: 12px; }
      @media print {
        .page { border: none; padding: 0; margin: 0; }
        a { color: inherit; text-decoration: none; }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <div class="title" style="justify-content: space-between;">
        <div class="title">
          <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--primary);"></span>
          <h1 style="margin:0;">Canva Connect 电商 Demo - 同事快速启动（macOS）</h1>
        </div>
        <span class="badge">1 页指南</span>
      </div>

      <p class="muted">本页可直接“文件 → 打印 → 存储为 PDF”导出为 PDF 分享。</p>

      <h2>一、安装必备软件（一次即可）</h2>
      <div class="steps">
        <div class="step">
          <div class="title">1) 安装 Git</div>
          <p>在"终端 Terminal"执行：</p>
          <div class="block"><code>xcode-select --install</code></div>
        </div>
        <div class="step">
          <div class="title">2) 安装 Node.js 20（必须）</div>
          <p class="muted small"><strong>重要：</strong>请使用 Node 20.x，Node 22 存在兼容性问题。</p>
          <p>如使用 Homebrew：</p>
          <div class="block"><code>brew install node@20</code></div>
          <p class="small muted">若在 macOS 15 上遇到 Homebrew 不支持的提示，请改用以下任一备用方案：</p>
          <div class="cols small">
            <div>
              <p><strong>A) 使用 nvm 安装（推荐）</strong></p>
              <div class="block"><pre style="margin:0;white-space:pre-wrap;"># 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# 重新打开终端或执行：
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

# 安装并使用 Node 20
nvm install 20
nvm use 20
node -v
npm -v</pre></div>
            </div>
            <div>
              <p><strong>B) 官方安装包</strong></p>
              <p>访问 <span class="code">https://nodejs.org/</span> 下载 macOS 20.x LTS 安装包（Apple Silicon/Intel 对应架构）。安装完成后在终端执行 <span class="code">node -v</span> 与 <span class="code">npm -v</span> 确认。</p>
            </div>
          </div>
        </div>
      </div>

      <h2>二、获取代码并一键启动</h2>
      <div class="steps">
        <div class="step">
          <div class="title">3A) 公有仓库 · HTTPS 快速克隆（无需 GitHub 账号）</div>
          <div class="block"><code>git clone https://github.com/MumuIs/CanvaAPI-Demo.git<br/>cd CanvaAPI-Demo</code></div>
          <p class="muted small">如出现浏览器登录/credential 异常，见下方“HTTPS 凭据修复”。</p>
        </div>
        <div class="step">
          <div class="title">3B) 推荐：配置 SSH 并克隆（长期更省心）</div>
          <p>仅需一次配置 SSH，后续无需反复登录。</p>
          <div class="block small"><pre style="margin:0;white-space:pre-wrap;"># 生成 SSH 密钥（已存在可跳过）
ssh-keygen -t ed25519 -C "你的邮箱"
eval "$(ssh-agent -s)"
ssh-add --apple-use-keychain ~/.ssh/id_ed25519
pbcopy < ~/.ssh/id_ed25519.pub   # 粘贴到 GitHub > Settings > SSH and GPG keys

# 测试连接（看到成功提示即可）
ssh -T git@github.com

# 克隆项目
git clone git@github.com:MumuIs/CanvaAPI-Demo.git
cd CanvaAPI-Demo</pre></div>
          <p class="muted small">公有仓库可直接用 HTTPS；团队长期协作建议改用 SSH。</p>
        </div>
        <div class="step">
          <div class="title">HTTPS 凭据修复（出现浏览器登录或 credential 错误时）</div>
          <p class="muted small">如果出现 <span class="code">git: 'credential-' 不是一个 git 命令</span>、或反复要求浏览器登录，可先修正凭据助手：</p>
          <div class="block small"><pre style="margin:0;white-space:pre-wrap;">git config --global --get-all credential.helper
git config --global --unset-all credential.helper
git config --global credential.helper osxkeychain

git clone https://github.com/MumuIs/CanvaAPI-Demo.git
cd CanvaAPI-Demo</pre></div>
        </div>
        <div class="step">
          <div class="title">4) 赋予脚本权限 & 一键启动</div>
          <div class="block"><code>chmod +x ./bootstrap.sh<br/>./bootstrap.sh</code></div>
          <p class="muted small">首次若未检测到 <span class="code">.env</span>，脚本会自动生成模板并退出，请先填写后再次运行脚本。</p>
        </div>
      </div>

      <h2>三、填写 .env（仅首次）</h2>
      <div class="step">
        <p><strong style="color:#d32f2f;">⚠️ 重要：.env 文件位置必须正确</strong></p>
        <p>正确路径：<span class="code" style="background-color:#fff3cd;padding:2px 6px;font-weight:600;">CanvaAPI-Demo/canva-connect-api-starter-kit/.env</span></p>
        <p class="muted small">注意：<strong>不是</strong> <span class="code" style="text-decoration:line-through;">demos/ecommerce_shop/.env</span>（此文件不会被读取）</p>
        
        <div class="cols">
          <div>
            <p>打开方式 A（VS Code，推荐）：</p>
            <div class="block"><code>cd ~/CanvaAPI-Demo<br/>open -a "Visual Studio Code" canva-connect-api-starter-kit/.env</code></div>
          </div>
          <div>
            <p>打开方式 B（文本编辑）：</p>
            <div class="block"><code>cd ~/CanvaAPI-Demo<br/>open -e canva-connect-api-starter-kit/.env</code></div>
          </div>
        </div>
        <p class="muted small">💡 小技巧：如果不确定打开的是否为正确文件，可以先执行 <span class="code">cd ~/CanvaAPI-Demo</span> 确保在项目根目录。</p>
      </div>
        <p>把下列内容粘贴到 .env（替换为负责人提供的真实值；变量名需与源码校验一致，合计 8 项）：</p>
        <div class="block small"><pre style="margin:0;white-space:pre-wrap;">BACKEND_PORT=3001
BACKEND_URL=http://127.0.0.1:3001
FRONTEND_URL=http://127.0.0.1:3000
BASE_CANVA_CONNECT_API_URL=https://api.canva.cn/rest
BASE_CANVA_CONNECT_AUTH_URL=https://www.canva.cn/api

CANVA_CLIENT_ID=粘贴完整的ClientId
CANVA_CLIENT_SECRET=粘贴完整的ClientSecret

DATABASE_ENCRYPTION_KEY=dev-encryption-key-32-chars-12345678</pre></div>
        <p class="muted small">备注：
          <br/>1) <span class="code">BASE_CANVA_CONNECT_API_URL</span> 不需要带 <span class="code">/v1</span>（代码会自动添加）；<span class="code">BASE_CANVA_CONNECT_AUTH_URL</span> 必须带 <span class="code">/api</span>（非中国区用 canva.com）
          <br/>2) 首次运行 <span class="code">./bootstrap.sh</span> 若未检测到 <span class="code">.env</span>，将自动生成最小模板并退出，请先填写再重新运行脚本。
          <br/>3) 负责人需在 Canva 应用后台配置回调 <span class="code">http://127.0.0.1:3001/oauth/redirect</span>。
        </p>
      </div>

      <h2>四、.env 配置验证（首次必做）</h2>
      <div class="steps">
        <div class="step">
          <div class="title">验证 .env 文件是否被正确读取</div>
          <p>在启动前，建议先验证环境变量配置是否正确：</p>
          <div class="block small"><pre style="margin:0;white-space:pre-wrap;"># 1. 确认 .env 文件位置（应只有一个）
cd ~/CanvaAPI-Demo
/usr/bin/find canva-connect-api-starter-kit -maxdepth 2 -name ".env*" -print

# 2. 检查 CLIENT_ID 和 SECRET 长度与前缀（不显示完整值）
node -e "require('./canva-connect-api-starter-kit/node_modules/dotenv').config({path:'canva-connect-api-starter-kit/.env'});const r=v=>({len:(v||'').length,head:(v||'').slice(0,8)});console.log({ID:r(process.env.CANVA_CLIENT_ID),SECRET:r(process.env.CANVA_CLIENT_SECRET)})"

# 3. 检查 API URL 配置
grep '^BASE_CANVA_CONNECT_API_URL=' canva-connect-api-starter-kit/.env</pre></div>
          <p class="muted small"><strong>预期结果：</strong></p>
          <p class="muted small">- CLIENT_ID 长度应为 15-20 左右，前缀类似 <span class="code">OC-AZbW7</span></p>
          <p class="muted small">- CLIENT_SECRET 长度应为 60+ 字符</p>
          <p class="muted small">- API URL 应为 <span class="code">https://api.canva.cn/rest</span>（不带 /v1）</p>
        </div>
        <div class="step">
          <div class="title">常见配置错误修复</div>
          <p class="muted small"><strong>如果 CLIENT_ID/SECRET 长度为 0 或很小：</strong></p>
          <p class="small">说明值为空或被截断，请从 Canva 开发者控制台重新完整复制，不要有空格、引号、中文字符。</p>
          <p class="muted small"><strong>如果值包含隐藏字符（如回车、BOM）：</strong></p>
          <div class="block small"><pre style="margin:0;white-space:pre-wrap;"># 清理隐藏字符
cd ~/CanvaAPI-Demo/canva-connect-api-starter-kit
LC_ALL=C tr -d '\r' < .env | sed '1s/^\xEF\xBB\xBF//' > /tmp/.env.clean && mv /tmp/.env.clean .env</pre></div>
        </div>
      </div>

      <h2>五、启动与使用</h2>
      <div class="steps">
        <div class="step">
          <div class="title">5) 若未在运行，手动启动</div>
          <div class="block"><code>cd canva-connect-api-starter-kit<br/>npm ci<br/>npm run demo:ecommerce</code></div>
          <p class="muted small">终端出现 "Ecommerce shop backend listening on port 3001" 即后端就绪。</p>
          <p class="muted small">若提示端口占用 (EADDRINUSE)，先清理旧进程：<span class="code">lsof -ti:3000 | xargs kill -9; lsof -ti:3001 | xargs kill -9</span></p>
        </div>
        <div class="step">
          <div class="title">6) 打开前端并授权</div>
          <p>浏览器访问 <span class="code">http://127.0.0.1:3000</span>，在首页点击"连接 Canva"，按提示完成授权。</p>
        </div>
      </div>

      <h2>六、更新项目（拉取最新版本）</h2>
      <div class="steps">
        <div class="step">
          <div class="title">推荐：一键更新脚本 ⭐</div>
          <p>最简单的方式，自动完成所有更新步骤：</p>
          <div class="block"><code>cd CanvaAPI-Demo<br/>./update.sh</code></div>
          <p class="muted small">脚本会自动：拉取最新代码 → 更新依赖 → 停止旧服务 → 启动新服务</p>
          <p class="muted small">提示：<span class="code">.env</span> 配置文件不会被覆盖，保留你的本地配置。</p>
        </div>
        <div class="step">
          <div class="title">或手动更新（分步执行）</div>
          <p>如果需要更精细的控制，可以分步执行：</p>
          <div class="block small"><pre style="margin:0;white-space:pre-wrap;"># 进入项目目录
cd CanvaAPI-Demo

# 1. 拉取最新代码
git pull

# 2. 更新依赖（如果 package.json 有变化）
cd canva-connect-api-starter-kit
npm ci

# 3. 重启服务（先 Ctrl+C 停止当前服务，然后执行）
npm run demo:ecommerce</pre></div>
        </div>
        <div class="step">
          <div class="title">遇到问题时：完全清理重装</div>
          <p>如果更新后出现异常，可以清理并重新安装：</p>
          <div class="block small"><pre style="margin:0;white-space:pre-wrap;"># 停止所有服务
lsof -ti:3000 | xargs kill -9 2>/dev/null
lsof -ti:3001 | xargs kill -9 2>/dev/null

# 清理并重新安装
cd canva-connect-api-starter-kit
rm -rf node_modules package-lock.json
npm install
npm run demo:ecommerce</pre></div>
        </div>
      </div>

      <p class="muted small" style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border);">
        <strong>遇到问题？</strong> 参考 <span class="code">docs/Troubleshooting_Startup.md</span> 获取完整修复步骤、诊断命令与已验证的解决方案。
      </p>
      <p class="muted small" style="margin-top:12px;">版本：v0.3.0-teammates-quickstart · 如需帮助请联系项目负责人。</p>
    </main>
  </body>
  </html>


